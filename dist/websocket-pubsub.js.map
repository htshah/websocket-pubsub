{"version":3,"file":"websocket-pubsub.js","sources":["../src/utils.js","../src/index.js"],"sourcesContent":["export function log() {\n  // eslint-disable-next-line no-unused-expressions,no-undef,no-console\n  !PRODUCTION && console.log.apply(null, arguments);\n}\n\n/**\n * Overwrites all the values in 'a' by values\n * in 'b' and returns a new object containing\n * new values.\n *\n * @param {Object} a Object in which overwrites will happen\n * @param {Object} b Object from which new values will be taken\n */\nexport function updateDefaults(a, b) {\n  const temp = {};\n\n  Object.keys(a).forEach((key) => {\n    // eslint-disable-next-line no-prototype-builtins\n    temp[key] = b.hasOwnProperty(key) ? b[key] : a[key];\n  });\n  return temp;\n}\n\nexport function split(str, delimiter) {\n  const pos = str.indexOf(delimiter);\n  return [str.substr(0, pos), str.substr(pos + 1)];\n}\n","import { log, updateDefaults, split } from './utils';\n\nconst WebsocketPubSub = function (url, userOptions) {\n  log('🚀 Creating a websocket...');\n  this.ws = this._createObj(url);\n\n  log('🧰 Configuring...');\n\n  // Default options\n  const defaultOptions = {\n    reconnect: true,\n    attempts: 5,\n    timeout: 3000,\n    buffer: true,\n    url,\n  };\n\n  // Overwrite default options\n  this._options = updateDefaults(defaultOptions, userOptions || {});\n  log('✔ Configured:', this._options);\n\n  this._init();\n};\n\nWebsocketPubSub.prototype = {\n  _uid: -1, // Stores last UID generated\n  _delimiter: ' ', // Delimiter for channel\n  _sub: {}, // Stores list of subscriptions for each channels registered.\n  isOpen: false, // Tells whether the websocket is connected or not.\n  _buffer: [],\n  _lastPing: false,\n  _stillConnected: false,\n  _createObj(url) {\n    // Use MozWebSocket if browser is Firefox\n    const Socket =\n      'MozWebSocket' in window ? window.MozWebSocket : window.WebSocket;\n\n    // Create a new Socket object\n    return new Socket(url);\n  },\n  _init() {\n    this.isOpen = false;\n    this.ws.onopen = () => {\n      log('Connection opened');\n      this.isOpen = true;\n      // Bind events\n      this._onMessage();\n      this.ws.onclose = this._onClose;\n      this._onError();\n\n      // Send buffered messages.\n      this._emitBuffered();\n\n      // Continuously check if server is still\n      // connected or not.\n      //! __ is a reserved channel name.\n      this._key = this.subscribe('__', (data) => {\n        if (data === 'ping' || data === 'pong') {\n          this._stillConnected = true;\n        }\n      });\n\n      this._pingLoop = setInterval(() => {\n        if (this._lastPing !== false && !this._stillConnected) {\n          this._onClose(); // Close connection\n          return;\n        }\n        this._lastPing = true;\n        this._stillConnected = false;\n        this.emit('__', 'ping');\n      }, this._options.timeout);\n    };\n\n    // Autoclose after a timeout if no connection can be made\n    setTimeout(() => {\n      if (\n        this.ws !== null &&\n        (this.ws.readyState === 0 || this.ws.readyState === 3)\n      ) {\n        log(\"Couldn't connect to target. Closing connection...\");\n        this._onClose();\n      }\n    }, this._options.timeout);\n  },\n  _onMessage() {\n    this.ws.onmessage = (event) => {\n      log(`Received: ${event.data}`);\n\n      // Separate channel and payload;\n      const parsedData = split(event.data, this._delimiter);\n      const channel = parsedData[0];\n      const payload = parsedData[1];\n\n      // Invoke all the callbacks for given\n      // channel.\n      const cbs = this._sub[channel];\n      Object.keys(cbs).map((k) => cbs[k](payload, event));\n    };\n  },\n  _onClose() {\n    log('❌ Closing');\n\n    clearInterval(this._pingLoop);\n    if (this._options.reconnect && this._options.attempts > 0) {\n      log(`Reconnecting..`);\n      this._options.attempts -= 1;\n      this.unsubscribe(this._key);\n      this.ws = this._createObj(this._options.url);\n      this._init();\n    } else {\n      log('✔ Closed');\n    }\n  },\n  _onError() {\n    this.ws.onerror = () => {\n      log('Some error occured');\n    };\n  },\n  emit(channel, payload) {\n    log(`Emitting: ${payload}`);\n    const parsedPayload = JSON.stringify(payload);\n    const msg = `${channel} ${parsedPayload}`;\n    if (this.isOpen) {\n      this.ws.send(msg);\n    } else if (this._options.buffer) {\n      this._buffer.push(msg);\n    }\n  },\n  _emitBuffered() {\n    if (this.isOpen && this._buffer.length > 0) {\n      this._buffer.forEach((msg) => {\n        log(`Emitting buffered: ${msg}`);\n        this.ws.send(msg);\n      });\n      this._buffer = [];\n    }\n  },\n  subscribe(channel, cb) {\n    log(`Subscribing to ${channel}`);\n    const sub = this._sub;\n    this._uid += 1;\n    sub[channel] = sub[channel] || {};\n    sub[channel][this._uid] = cb;\n\n    return `${channel} ${this._uid}`;\n  },\n  unsubscribe(key) {\n    if (key === undefined) {\n      return;\n    }\n    log(`Unsubscribing from ${key}`);\n    const parsedKey = split(key, ' ');\n    const channel = parsedKey[0];\n    const uid = parsedKey[1];\n\n    // Remove cb from the channel's list.\n    delete this._sub[channel][uid];\n  },\n};\n\nexport default WebsocketPubSub;\n"],"names":["log","updateDefaults","a","b","temp","Object","keys","forEach","key","hasOwnProperty","split","str","delimiter","pos","indexOf","substr","WebsocketPubSub","url","userOptions","ws","_createObj","defaultOptions","reconnect","attempts","timeout","buffer","_options","_init","prototype","_uid","_delimiter","_sub","isOpen","_buffer","_lastPing","_stillConnected","Socket","window","MozWebSocket","WebSocket","onopen","_onMessage","onclose","_onClose","_onError","_emitBuffered","_key","subscribe","data","_pingLoop","setInterval","emit","setTimeout","readyState","onmessage","event","parsedData","channel","payload","cbs","map","k","clearInterval","unsubscribe","onerror","parsedPayload","JSON","stringify","msg","send","push","length","cb","sub","undefined","parsedKey","uid"],"mappings":"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"}