var WebsocketPubSub=function(){"use strict";function t(t,i){var n=t.indexOf(i);return[t.substr(0,n),t.substr(n+1)]}var i=function(t,i){this.ws=this._createObj(t);var n,s,e,o={reconnect:!0,attempts:5,timeout:3e3,buffer:!0,url:t};this._options=(n=o,s=i||{},e={},Object.keys(n).forEach((function(t){e[t]=s.hasOwnProperty(t)?s[t]:n[t]})),e),this._options,this._init()};return i.prototype={_uid:-1,_delimiter:" ",_sub:{},isOpen:!1,_buffer:[],_lastPing:!1,_stillConnected:!1,_createObj:function(t){return new("MozWebSocket"in window?window.MozWebSocket:window.WebSocket)(t)},_init:function(){var t=this;this.isOpen=!1,this.ws.onopen=function(){t.isOpen=!0,t._onMessage(),t.ws.onclose=t._onClose,t._onError(),t._emitBuffered(),
//! __ is a reserved channel name.
t._key=t.subscribe("__",(function(i){"ping"!==i&&"pong"!==i||(t._stillConnected=!0)})),t._pingLoop=setInterval((function(){!1===t._lastPing||t._stillConnected?(t._lastPing=!0,t._stillConnected=!1,t.emit("__","ping")):t._onClose()}),t._options.timeout)},setTimeout((function(){null===t.ws||0!==t.ws.readyState&&3!==t.ws.readyState||t._onClose()}),this._options.timeout)},_onMessage:function(){var i=this;this.ws.onmessage=function(n){n.data;var s=t(n.data,i._delimiter),e=s[0],o=s[1],r=i._sub[e];Object.keys(r).map((function(t){return r[t](o,n)}))}},_onClose:function(){clearInterval(this._pingLoop),this._options.reconnect&&this._options.attempts>0&&(this._options.attempts-=1,this.unsubscribe(this._key),this.ws=this._createObj(this._options.url),this._init())},_onError:function(){this.ws.onerror=function(){}},emit:function(t,i){var n=t+" "+JSON.stringify(i);this.isOpen?this.ws.send(n):this._options.buffer&&this._buffer.push(n)},_emitBuffered:function(){var t=this;this.isOpen&&this._buffer.length>0&&(this._buffer.forEach((function(i){t.ws.send(i)})),this._buffer=[])},subscribe:function(t,i){var n=this._sub;return this._uid+=1,n[t]=n[t]||{},n[t][this._uid]=i,t+" "+this._uid},unsubscribe:function(i){if(void 0!==i){var n=t(i," "),s=n[0],e=n[1];delete this._sub[s][e]}}},i}();
